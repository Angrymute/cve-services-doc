# ESUS


# CRUD Requirements

### Allow a user to submit and update a CVE for their CNA
User has to belong to the CNA that the CVE ID is allocated to.
- CVE must pass CVE Schema v5
- CVE ID state gets updated to Public
- CVE Entry state gets updated to Populated
- ! Possibly can combine Entry and ID states

! What extra data gets stored for internal tracking?
- Should record the submitter. Use username/UUID like the CNA in the User Registry. Keep from public.
- CVE ID is already tied to the CNA. That CNA is the only one who can create and update. (CNA container, at least). So ESUS may not need to add additional data for this necessary tracking.

! Assigner is an email address.
- How do we ensure this tracks back to the CNA?
- It would be better to use a stable identifier for the Org/User since their contact information could be updated without changing the CVE.
- Pair a UUID with a short name.
- Both UUID and short name stored with CVE. CVE short name recorded would not change if short name changed, but UUID will still track back in User Registry for most up to date contact information.
- Even if CNA left and rejoined, UUID could be reused.
- Resolution: Assigner becomes either an email address or an object with UUID and short name of CNA.


! Assigner should be a write once field
- Resolution: Using the current CNA container field, there is a `provider_data_meta` object, it has an ID property which can be the current CNA maintainer. That ID property will also need to be updated to support either email address or UUID & short name (of the CNA).

### Allow a user to get a CVE
> Note: For CVEs currently in GitHub (1999-current), will need to use the CVE Schema v5 upgrader, then insert into ESUS' store.

! Every CVE record will need proper ties to CNAs.
- Hands on data upgrade problem. Secretariat job.

! What data can be seen by the public (I.E. world)?
- Assuming the repo `cvelist` is the example, so the JSON that was submitted initially.

! What data can be seen by "authenticated user" but not public (I.E. general users of the system)?
- A user for a CNA should be able to ask for all their reserved CVEs. That JSON data still does not reveal this fact.
- Additionally, they should be able to filter by state.

Public and Rejected state CVE are all public for everyone.

### Allow a user to get all the CVEs
Provide a GET all CVE endpoint for CVE website that allows limitations on the response i.e. does not return full result (stateless and idempotent). This is necessary so a browser does not crash trying to hold all CVEs while trying to allow a User to scroll through a large list or set of CVEs.
! Action Item: We need to gather what queries the community will want to perform on this endpoint. 
- Gather how the community will want to interact with the API.
	- Would GraphQL be acceptable? Would allow a wide search capability at release of MVP.
		- Important question: can we limit what data can be seen if we use GraphQL? Otherwise, how will we limit the query for allocated(**pre-populated!**) IDs for a given CNA.
		- [GraphQL Security](https://www.howtographql.com/advanced/4-security/) for possibilities of implementation
		- Possibly able to insert the user as a filter?
	- Are there equivalents to GraphQL the community would prefer?
	- Do we need to provide an alternative to GraphQL through typical REST URL queries?
	- Can we allow customers to specify what data fields they want returned?
	- Gather what queries the community will want to use currently and then decide which will be in MVP.

How do we police the load clients put on the system?
Some throttling of clients is desired
- Need to investigate options
! Does MVP strictly limit API endpoints to those with an API secret, that being only users for a CNA? Yes
! Action Item: Define what limits we place on requesters

### ESUS / User Registry needs read only role for get CVE
Manually registered for MVP, but can use API Secret to read CVE list.

What medium should we use for a full list pull?
Possibilities:
- FTP endpoint to return JSON file. File updated at certain times.
- REST API endpoint that returns the JSON file in the MIME type `application/octet-stream`, essentially HTTP's version of FTP. File still updated at certain times.
- RSS feed possibility as well?
> If the above endpoint fulfills community needs from a load perspective, this can be left for later.

### Root CNA can submit and update a CVE on behalf of Sub-CNAs
If a Root CNA attempts an action with a Sub-CNA's CVE ID, it is assumed they are acting on behalf of that CNA.
- `provider_data_meta` has to be a Sub-CNA or themselves.
! Action Item: check with SPWG that this is acceptable.

### `provider_data_meta` has to be the CNA if it's a regular CNA

### Secretariat can create a CVE on behalf of any CNA
### Secretariat can update any part of a CVE for any CNA
- The CVE_data_meta as Secretariat?
- The CNA container on behalf of the CNA
- The ADP container on behalf of the ADP


## State-Centered Requirements

### CNA can change state of CVE
Allowed State Progression
- Allocated -> Populated
- Allocated -> Rejected
- Populated -> Rejected
- Admin can restore a rejected CVE to populated
> Note: Assigned / Public can be a flag or community language, not really states

### Rejecting CVEs
- Root CNA and CNA are limited to how many can be rejected over a certain amount of time
- Secretariat is allowed to batch reject for emergency purposes

### Restoring rejected CVEs
- Root Admin, Secretariat, and CNA Admin can go Rejected -> Populated
! Is there a limit on this as well?
	- Good solution would be to have a time window for when a Root CNA or CNA can go from Rejected -> Populated.
	- Suggested time window was 5 days.
	- Secretariat can make change beyond that.
! Need to enforce that it was previously Populated. Otherwise, it could be Allocated -> Rejected -> Populated
- Rejected IDs cannot go from Rejected -> Allocated even if there is a mistake


## Source of Record Requirements / Auditable Requirements

### Must have some ability to track changes made to a CVE in order to supplant CPS as source of record
- Submissions, changes, etc are tracked -> what user and their CNA at the time did the action.
- Data is **not** exposed, but kept for future auditing capabilities.
! > Will need to cover GDPR for this -> right to be forgotten.
	- In order to simplify compliance with GDPR, require Assigned_By and Requested_By to be User Registry UUIDs for users, not personally identifiable information. This way, users can be removed from User Registry and CVE records not be affected.

### For previous history tracking before ESUS implementation
Refer to previous sources for MVP and possibly post-MVP. Assess need to convert at a later time.


## Container Requirements

### ADP Container
If the user is submitting data but isn't the CNA connected to the ID/Entry (isn't the `provider_data_meta`), that is adp container data tied to that user's organization. If that org doesn't have ADP status the action is not allowed.
- Root CNA can add data as an adp container, for clarification, but cannot modify adp container data with `provider_data_meta` being a CNA that is not their Sub-CNA.

### CNA Container
Only the CNA and its Root (and Secretariat) can modify cna container data for a CVE where they are the `provider_data_meta`.


## Discussion

### ESUS must accept CVEs that have additional fields than what the JSON Schema describes and store this data
- When is this additional data returned?
	- Are we going to have to "cleanse" these fields from the record when returning to the public? 
- Are we expected to provide search abilities on these data fields?
- What limits can we put on this? Leaving it open ended is somewhat unsafe as, if there's no rule against it, CNAs could start submitting anything:
	- whole URL encoded byte arrays of jpegs or pngs
	- executable code
	- an infinite number of normal JSON data types, bloating the CVE
Agreement on size limit of payload (1MB? possibly?)
Set expectation that extra fields will not be queryable by GraphQL
Could be possible to lock down all of the CVE JSON fields and direct the ability to add additional fields to containers. This way, the CVE structure is strict and flexibility is allowed in the containers.

### Notes for User Registry
Global ADP -> Organization with users that can contribute ADP container data to any CVE. Highest Level Root is their Root CNA (org).

CNAs have an "ADP" indication that allows them to contribute adp container data to CVEs. Hierarchal scope comes later.

For clarification, User Registry also needs a CNA indication so an organization can have their CNA status revoked but it's still possible to keep ADP status.

### Notes
CNA has full access to metadata
Privileged Root User ^
Public can only see ID status, public CVE data
! How does the CNA submit "embargoed data"?
- Defer on design, possibly a new sub system to support Root/Sub system process. Not necessarily a part of ESUS, possibly.
> Note: we should store this data in a separate collection but link it with the CVE ID.
